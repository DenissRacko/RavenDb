@model Logic.ViewModels.LoginModel

@{
    ViewBag.Title = "Login";
    var newSessionId = Guid.NewGuid();
}

<h2>Login</h2>

@using (Html.BeginForm()) 
{
    @Html.AntiForgeryToken()
    
    <div id="login-form" class="form-horizontal">
        <h4>LoginModel</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.HiddenFor(m => m.CompanyId)
        @Html.HiddenFor(m => m.SessionId)
        <div class="form-group">
            @Html.LabelFor(model => model.Login, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Login, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Login, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Password, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.PasswordFor(model => model.Password, new { @class = "form-control" })
                @Html.ValidationMessageFor(model => model.Password, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Submit" class="btn btn-default" />
            </div>
        </div>
    </div>
}

<div>
    @Html.ActionLink("Back to List", "Index", "Home")
</div>


<script type="text/javascript">
    $(function () {
        var form = $("#login-form").closest("form");

        if ("@Model.Successful" == "False")
        {
            $.removeCookie("session-@Model.CompanyId");
        }

        var cookie = $.cookie("session-@Model.CompanyId");
        var sessionInput = form.find("input[name='@Html.NameFor(m => m.SessionId)']").first();

        if (cookie == null) {
            sessionInput.val("@newSessionId");
        }
        else {
            sessionInput.val(cookie);
        }

        form.submit(function () {
            if (cookie == null) {
                $.cookie("session-@Model.CompanyId", "@newSessionId", { path: '/' });
            }
        });

    });
</script>